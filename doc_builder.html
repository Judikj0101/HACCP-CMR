<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; 
            display: flex; 
            flex-direction: column;
        }
        
        .header { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: var(--gray-800); 
            padding: 16px 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: var(--shadow);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 { 
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .team-info { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 13px;
        }
        
        .team-badge { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 6px 14px; 
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.3px;
        }
        
        .sync-status { 
            display: flex; 
            align-items: center; 
            gap: 6px;
            background: var(--gray-100);
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .sync-indicator { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: var(--success);
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .sync-indicator.syncing { 
            background: var(--warning);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        .sync-indicator.error { 
            background: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.6; } 
        }
        
        .header-buttons { 
            display: flex; 
            gap: 8px;
        }
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-tabs { display: flex; border-bottom: 2px solid #ddd; background: #f8f9fa; }
        .sidebar-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 500; color: #7f8c8d; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .sidebar-tab:hover { background: #ecf0f1; }
        .sidebar-tab.active { color: #2c3e50; border-bottom-color: #3498db; background: white; }
        .sidebar-content { 
            display: none; 
            flex: 1; 
            overflow-y: auto;
        }
        
        .sidebar-content.active { 
            display: block;
        }
        
        .sidebar-header { 
            padding: 20px;
        }
        
        .sidebar-header h2 { 
            font-size: 16px; 
            margin-bottom: 12px; 
            color: var(--gray-800);
            font-weight: 700;
        }
        
        .add-group-btn { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            width: 100%; 
            margin-bottom: 10px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        .add-group-btn:hover { 
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .add-group-btn:active {
            transform: translateY(0);
        }
        .documents-list { padding: 20px; }
        .document-item { padding: 15px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; background: white; }
        .document-item:hover { border-color: #3498db; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .document-item.active { border-color: #2ecc71; background: #f0fff4; }
        .document-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .document-item-title { font-weight: 600; color: #2c3e50; font-size: 14px; flex: 1; }
        .document-item-date { font-size: 11px; color: #95a5a6; margin-bottom: 5px; }
        .document-item-preview { font-size: 12px; color: #7f8c8d; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .document-item-actions { display: flex; gap: 5px; }
        .document-item-actions button { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .document-item-actions button:hover { background: #c0392b; }
        .document-item-actions button.rename-btn { background: #3498db; }
        .document-item-actions button.rename-btn:hover { background: #2980b9; }
        .new-document-btn { 
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white; 
            border: none; 
            padding: 12px 16px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 14px; 
            width: 100%; 
            margin-bottom: 16px; 
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }
        
        .new-document-btn:hover { 
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .empty-state { text-align: center; padding: 40px 20px; color: #95a5a6; }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; }
        .block-group { border-bottom: 1px solid #e0e0e0; }
        .group-header { padding: 15px 20px; background: #ecf0f1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .group-header:hover { background: #e0e0e0; }
        .group-title { font-weight: 600; color: #2c3e50; flex: 1; }
        .group-controls { display: flex; gap: 5px; }
        .group-controls button { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .group-controls button:hover { background: #c0392b; }
        .group-arrow { margin-right: 10px; transition: transform 0.2s; }
        .group-header.collapsed .group-arrow { transform: rotate(-90deg); }
        .block-palette { padding: 10px 20px 20px; display: flex; flex-direction: column; gap: 8px; }
        .block-palette.collapsed { display: none; }
        .block-template { padding: 10px; background: #3498db; color: white; border-radius: 6px; cursor: grab; transition: all 0.2s; text-align: center; font-weight: 500; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .block-template:hover { background: #2980b9; transform: translateY(-2px); }
        .block-template:active { cursor: grabbing; }
        .edit-template-btn { background: rgba(255,255,255,0.3); border: none; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .edit-template-btn:hover { background: rgba(255,255,255,0.5); }
        .add-block-btn { background: #95a5a6; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 5px; }
        .add-block-btn:hover { background: #7f8c8d; }
        .canvas { flex: 1; padding: 40px; overflow-y: auto; }
        .document { max-width: 800px; margin: 0 auto; background: white; min-height: 600px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        .formatting-toolbar { display: none; position: sticky; top: 0; background: white; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 20px; gap: 5px; flex-wrap: wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 100; }
        .formatting-toolbar.active { display: flex; }
        .toolbar-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .toolbar-btn:hover { background: #ecf0f1; border-color: #3498db; }
        .toolbar-separator { width: 1px; background: #ddd; margin: 0 5px; }
        .toolbar-select { border: 1px solid #ddd; padding: 8px; border-radius: 4px; cursor: pointer; background: white; }
        .doc-block { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            position: relative; 
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .doc-block:hover { 
            border-color: var(--primary-light);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }
        
        .doc-block.editing { 
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }
        
        .block-controls { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            display: flex; 
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .doc-block:hover .block-controls {
            opacity: 1;
        }
        
        .block-controls button { 
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        .block-controls button:hover { 
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .block-content { outline: none; min-height: 30px; }
        .block-content h1 { font-size: 32px; color: #2c3e50; margin-bottom: 10px; }
        .block-content h2 { font-size: 24px; color: #34495e; margin-bottom: 8px; }
        .block-content h3 { font-size: 20px; color: #34495e; margin-bottom: 8px; }
        .block-content p { line-height: 1.6; color: #555; }
        .block-content ul, .block-content ol { margin-left: 30px; line-height: 1.8; color: #555; }
        .block-content img { max-width: 100%; height: auto; display: block; margin: 10px 0; }
        .btn { 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            font-size: 14px; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .export-btn { 
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }
        
        .save-btn { 
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }
        
        .load-btn { 
            background: linear-gradient(135deg, var(--secondary) 0%, #db2777 100%);
        }
        .drop-zone { 
            border: 2px dashed var(--gray-300);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
            padding: 32px; 
            text-align: center; 
            color: var(--gray-400);
            margin-bottom: 20px; 
            border-radius: var(--radius);
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .drop-zone:hover {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; }
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal-content textarea { width: 100%; min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 15px; }
        .modal-content input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .modal-buttons .cancel-btn { background: #95a5a6; color: white; }
        .modal-buttons .save-modal-btn { background: #3498db; color: white; }
        .image-upload-area { border: 2px dashed #3498db; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer; margin: 10px 0; }
        .image-upload-area:hover { background: #ecf0f1; }
        
        .block-editor { display: flex; flex-direction: column; gap: 15px; }
        .block-editor-label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .block-editor-toolbar { display: flex; gap: 5px; flex-wrap: wrap; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; }
        .block-editor-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .block-editor-btn:hover { background: #ecf0f1; border-color: #3498db; }
        .block-editor-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .block-editor-select { border: 1px solid #ddd; padding: 8px; border-radius: 4px; cursor: pointer; background: white; min-width: 120px; }
        .block-editor-content { border: 1px solid #ddd; border-radius: 6px; padding: 15px; min-height: 200px; background: white; outline: none; font-family: inherit; font-size: 14px; line-height: 1.6; }
        .block-editor-content:focus { border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .editor-separator { width: 1px; background: #ddd; margin: 0 5px; }

        .move-block-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 300px;
        }

        .move-block-modal.active {
            display: block;
        }

        .move-block-modal h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .move-block-modal select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .modal-overlay.active {
            display: block;
        }

        .variable-tag {
            background: #fff3cd;
            color: #856404;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            cursor: pointer;
        }

        .variable-tag:hover {
            background: #ffeaa7;
        }

        .client-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .client-form-full {
            grid-column: 1 / -1;
        }

        .client-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .client-form input, .client-form textarea, .client-form select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .client-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .client-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .client-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .client-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .client-item.selected {
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .client-item-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .client-item-details {
            font-size: 12px;
            color: #7f8c8d;
        }

        .client-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .client-actions button {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .client-actions .select-btn {
            background: #2ecc71;
            color: white;
        }

        .client-actions .edit-btn {
            background: #3498db;
            color: white;
        }

        .client-actions .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .variables-toolbar {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

        .variables-toolbar button {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .variables-toolbar button:hover {
            background: #2980b9;
        }

        .template-save-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .template-save-options button {
            flex: 1;
            padding: 12px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .template-save-options button:hover {
            background: #3498db;
            color: white;
        }

        .template-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .template-item-desc {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .template-item-actions {
            display: flex;
            gap: 5px;
        }

        .template-item-actions button {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
        }

        .template-item-actions .use-btn {
            background: #2ecc71;
        }

        .template-item-actions .delete-btn {
            background: #e74c3c;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-screen.active {
            display: flex;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-box h2 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .login-box p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .login-box input, .login-box select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .login-box button:hover {
            background: #2980b9;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        .user-badge:hover {
            background: rgba(255,255,255,0.3);
        }

        .role-badge {
            background: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: #e74c3c;
        }

        .role-badge.editor {
            background: #3498db;
        }

        .role-badge.viewer {
            background: #95a5a6;
        }

        .user-menu {
            position: absolute;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 10px;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .user-menu.active {
            display: block;
        }

        .user-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .user-menu-item:hover {
            background: #ecf0f1;
        }

        .search-bar {
            max-width: 800px;
            margin: 0 auto 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 15px;
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .keyboard-shortcuts.active {
            display: block;
        }

        .keyboard-shortcuts h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }

        .shortcut-key {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .table-btn {
            background: #9b59b6;
        }

        .table-btn:hover {
            background: #8e44ad;
        }

    </style>
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>üîê Login</h2>
            <p>Enter your credentials to access the Documentation Builder</p>
            <input type="text" id="loginUsername" placeholder="Username">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="login()">Login</button>
            <p style="margin-top: 20px; font-size: 12px; text-align: center;">
                Demo accounts:<br>
                admin / admin123<br>
                editor / editor123<br>
                viewer / viewer123
            </p>
        </div>
    </div>

    <div class="header">
        <div>
            <h1>üìù Documentation Builder</h1>
            <div class="team-info">
                <div class="user-badge" id="userBadge" onclick="toggleUserMenu()" style="display: none;">
                    <span id="userName">User</span>
                    <span class="role-badge" id="userRole">viewer</span>
                </div>
                <div class="team-badge" id="teamBadge">Team Mode</div>
                <div class="sync-status">
                    <div class="sync-indicator" id="syncIndicator"></div>
                    <span id="syncStatus">Synced</span>
                </div>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn save-btn" onclick="toggleShortcuts()">‚å®Ô∏è Shortcuts</button>
            <button class="btn save-btn" onclick="saveProject()">üíæ Export Backup</button>
            <button class="btn load-btn" onclick="loadProject()">üìÇ Import Backup</button>
            <button class="btn export-btn" onclick="exportToDocx()">üìÑ Export DOCX</button>
            <button class="btn export-btn" onclick="exportToPDF()" style="background: #e74c3c;">üìï Export PDF</button>
        </div>
    </div>

    <div class="user-menu" id="userMenu">
        <div class="user-menu-item" onclick="manageUsers()" id="manageUsersBtn">
            üë• Manage Users
        </div>
        <div class="user-menu-item" onclick="logout()">
            üö™ Logout
        </div>
    </div>

    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
        <div class="shortcut-item">
            <span>Save Document</span>
            <span class="shortcut-key">Ctrl+S</span>
        </div>
        <div class="shortcut-item">
            <span>New Document</span>
            <span class="shortcut-key">Ctrl+N</span>
        </div>
        <div class="shortcut-item">
            <span>Duplicate Block</span>
            <span class="shortcut-key">Ctrl+D</span>
        </div>
        <div class="shortcut-item">
            <span>Find</span>
            <span class="shortcut-key">Ctrl+F</span>
        </div>
        <div class="shortcut-item">
            <span>Hide Shortcuts</span>
            <span class="shortcut-key">Esc</span>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchTab('blocks')">üì¶ Blocks</div>
                <div class="sidebar-tab" onclick="switchTab('documents')">üìÑ Docs</div>
                <div class="sidebar-tab" onclick="switchTab('templates')">üìã Templates</div>
                <div class="sidebar-tab" onclick="switchTab('clients')">üë• Clients</div>
            </div>
            
            <div class="sidebar-content active" id="blocksTab">
                <div class="sidebar-header">
                    <h2>Building Blocks</h2>
                    <input type="text" id="blockSearch" placeholder="üîç Search blocks..." 
                           onkeyup="searchBlocks()" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                    <button class="add-group-btn" onclick="addGroup()" id="addGroupBtn">+ Add Group</button>
                </div>
                <div id="groupsContainer"></div>
            </div>

            <div class="sidebar-content" id="documentsTab">
                <div class="documents-list">
                    <button class="new-document-btn" onclick="createNewDocument()" id="newDocBtn">+ New Document</button>
                    <input type="text" id="docSearch" placeholder="üîç Search documents..." 
                           onkeyup="searchDocuments()" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                    <div id="documentsList"></div>
                </div>
            </div>

            <div class="sidebar-content" id="templatesTab">
                <div class="documents-list">
                    <div class="template-save-options">
                        <button onclick="saveAsTemplate()">üíæ Save Current as Template</button>
                    </div>
                    <div id="templatesList"></div>
                </div>
            </div>

            <div class="sidebar-content" id="clientsTab">
                <div class="documents-list">
                    <button class="new-document-btn" onclick="openClientForm()">+ Add Client</button>
                    <div id="clientsList"></div>
                </div>
            </div>
        </div>

        <div class="canvas">
            <div class="document-header">
                <div class="document-title">
                    <input type="text" id="currentDocumentTitle" value="Untitled Document" onchange="updateDocumentName()" placeholder="Document name...">
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="save-document-btn" onclick="insertVariable()" style="background: #9b59b6; padding: 8px 16px;">
                        üî§ Insert Variable
                    </button>
                    <button class="save-document-btn" onclick="fillVariables()" style="background: #f39c12; padding: 8px 16px;">
                        ‚ú® Fill Variables
                    </button>
                    <button class="save-document-btn" onclick="manualSaveDocument()">
                        <span id="saveButtonText">üíæ Save Document</span>
                    </button>
                </div>
            </div>

            <div class="formatting-toolbar" id="toolbar">
                <button class="toolbar-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                <button class="toolbar-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                <button class="toolbar-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                <div class="toolbar-separator"></div>
                <select class="toolbar-select" onchange="changeFontSize(this.value)">
                    <option value="">Font Size</option>
                    <option value="12px">12px</option>
                    <option value="14px">14px</option>
                    <option value="16px">16px</option>
                    <option value="18px">18px</option>
                    <option value="20px">20px</option>
                    <option value="24px">24px</option>
                    <option value="28px">28px</option>
                    <option value="32px">32px</option>
                    <option value="36px">36px</option>
                </select>
                <div class="toolbar-separator"></div>
                <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left">‚â°</button>
                <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="Align Center">‚â£</button>
                <button class="toolbar-btn" onclick="formatText('justifyRight')" title="Align Right">‚â°</button>
                <button class="toolbar-btn" onclick="formatText('justifyFull')" title="Justify">‚äû</button>
            </div>

            <div class="document" id="document">
                <div class="drop-zone">Drag blocks here to start building your document</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeMoveBlockModal()"></div>

    <div class="move-block-modal" id="moveBlockModal">
        <h4>Move Block to Group</h4>
        <select id="targetGroupSelect"></select>
        <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeMoveBlockModal()">Cancel</button>
            <button class="save-modal-btn" onclick="confirmMoveBlock()">Move</button>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>Edit Block Template</h3>
            <div class="block-editor">
                <div>
                    <div class="block-editor-label">Block Name</div>
                    <input type="text" id="blockName" placeholder="Enter block name...">
                </div>
                
                <div>
                    <div class="block-editor-label">Formatting Options</div>
                    <div class="block-editor-toolbar">
                        <button class="block-editor-btn" onclick="editorFormat('bold')" title="Bold"><b>B</b></button>
                        <button class="block-editor-btn" onclick="editorFormat('italic')" title="Italic"><i>I</i></button>
                        <button class="block-editor-btn" onclick="editorFormat('underline')" title="Underline"><u>U</u></button>
                        
                        <div class="editor-separator"></div>
                        
                        <select class="block-editor-select" id="editorFontFamily" onchange="editorFormat('fontName', this.value)">
                            <option value="">Font Family</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                        </select>
                        
                        <select class="block-editor-select" id="editorFontSize" onchange="editorFormat('fontSize', this.value)">
                            <option value="">Font Size</option>
                            <option value="1">10px</option>
                            <option value="2">13px</option>
                            <option value="3">16px</option>
                            <option value="4">18px</option>
                            <option value="5">24px</option>
                            <option value="6">32px</option>
                            <option value="7">48px</option>
                        </select>
                        
                        <div class="editor-separator"></div>
                        
                        <button class="block-editor-btn" onclick="editorFormat('justifyLeft')" title="Align Left">‚â°</button>
                        <button class="block-editor-btn" onclick="editorFormat('justifyCenter')" title="Align Center">‚â£</button>
                        <button class="block-editor-btn" onclick="editorFormat('justifyRight')" title="Align Right">‚â°</button>
                        <button class="block-editor-btn" onclick="editorFormat('justifyFull')" title="Justify">‚äû</button>
                        
                        <div class="editor-separator"></div>
                        
                        <button class="block-editor-btn" onclick="editorFormat('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                        <button class="block-editor-btn" onclick="editorFormat('insertOrderedList')" title="Numbered List">1. List</button>
                    </div>
                </div>
                
                <div>
                    <div class="block-editor-label">Content</div>
                    <div class="block-editor-content" id="blockEditorContent" contenteditable="true">
                        Start typing or format your text...
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="save-modal-btn" onclick="saveTemplate()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="groupModal">
        <div class="modal-content">
            <h3>Edit Group Name</h3>
            <input type="text" id="groupName" placeholder="Enter group name...">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="save-modal-btn" onclick="saveGroupName()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="clientModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="clientModalTitle">Add New Client</h3>
            <div class="client-form">
                <div>
                    <label>Company Name *</label>
                    <input type="text" id="clientCompany" required>
                </div>
                <div>
                    <label>Contact Person *</label>
                    <input type="text" id="clientContact" required>
                </div>
                <div>
                    <label>Email *</label>
                    <input type="email" id="clientEmail" required>
                </div>
                <div>
                    <label>Phone</label>
                    <input type="tel" id="clientPhone">
                </div>
                <div class="client-form-full">
                    <label>Address</label>
                    <textarea id="clientAddress"></textarea>
                </div>
                <div>
                    <label>City</label>
                    <input type="text" id="clientCity">
                </div>
                <div>
                    <label>Country</label>
                    <input type="text" id="clientCountry">
                </div>
                <div>
                    <label>Postal Code</label>
                    <input type="text" id="clientPostal">
                </div>
                <div>
                    <label>Tax ID / VAT</label>
                    <input type="text" id="clientTax">
                </div>
                <div>
                    <label>Industry</label>
                    <input type="text" id="clientIndustry">
                </div>
                <div>
                    <label>Website</label>
                    <input type="url" id="clientWebsite">
                </div>
                <div class="client-form-full">
                    <label>Notes</label>
                    <textarea id="clientNotes"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="save-modal-btn" onclick="saveClient()">Save Client</button>
            </div>
        </div>
    </div>

    <div class="modal" id="templateModal">
        <div class="modal-content">
            <h3>Save as Template</h3>
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Template Name</label>
                <input type="text" id="templateName" placeholder="Enter template name..." style="margin-bottom: 15px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description (optional)</label>
                <textarea id="templateDesc" placeholder="Describe when to use this template..." style="min-height: 80px;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button class="save-modal-btn" onclick="confirmSaveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kzzscdymubqabsgogqba.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6enNjZHltdWJxYWJzZ29ncWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzI3NTIsImV4cCI6MjA4MDAwODc1Mn0._GQdjZHUeG7CYAsvaqOrKN0TvSFRBYIBxvmad5Vl6Pg';
        const TEAM_ID = 'verifico_auditor';
        
        let supabase = null;
        let supabaseEnabled = false;
        
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            supabaseEnabled = true;
            updateSyncStatus('synced');
        } else {
            updateSyncStatus('error');
        }

        let draggedType = null;
        let draggedElement = null;
        let currentEditingTemplate = null;
        let currentEditingGroup = null;
        let groupCounter = 0;
        let blockCounter = 0;
        let currentEditingBlock = null;
        let currentDocumentId = null;
        let documents = {};
        let blockToMove = null;
        let clients = {};
        let selectedClient = null;
        let templates = {};
        let editingClientId = null;
        let currentUser = null;
        let users = {
            'admin': { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator' },
            'editor': { username: 'editor', password: 'editor123', role: 'editor', name: 'Editor User' },
            'viewer': { username: 'viewer', password: 'viewer123', role: 'viewer', name: 'Viewer User' }
        };

        const groups = {
            'group-0': {
                name: 'Default Blocks',
                blocks: {
                    'heading1': { name: 'Heading 1', content: '<h1>Heading 1</h1>' },
                    'heading2': { name: 'Heading 2', content: '<h2>Heading 2</h2>' },
                    'heading3': { name: 'Heading 3', content: '<h3>Heading 3</h3>' },
                    'paragraph': { name: 'Paragraph', content: '<p>Write your paragraph here...</p>' },
                    'bullet-list': { name: 'Bullet List', content: '<ul><li>Item 1</li><li>Item 2</li><li>Item 3</li></ul>' },
                    'numbered-list': { name: 'Numbered List', content: '<ol><li>Item 1</li><li>Item 2</li><li>Item 3</li></ol>' },
                    'image': { name: 'Image', content: '<div class="image-upload-area" onclick="uploadImage(this)">Click to upload image</div>' }
                }
            }
        };

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            const teamBadge = document.getElementById('teamBadge');
            
            indicator.className = 'sync-indicator';
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
                statusText.textContent = 'Syncing...';
            } else if (status === 'synced') {
                statusText.textContent = 'Synced';
                teamBadge.textContent = `Team: ${TEAM_ID}`;
            } else if (status === 'error') {
                indicator.classList.add('error');
                statusText.textContent = 'Offline Mode';
                teamBadge.textContent = 'Local Only';
            }
        }

        async function saveToSupabase(key, data) {
            if (!supabaseEnabled) return false;
            try {
                updateSyncStatus('syncing');
                const { error } = await supabase.from('team_documentation').upsert({
                    key: key, team_id: TEAM_ID, value: data, updated_at: new Date().toISOString()
                }, { onConflict: 'key,team_id' });
                if (error) throw error;
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Supabase save error:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        async function getFromSupabase(key) {
            if (!supabaseEnabled) return null;
            try {
                const { data, error } = await supabase.from('team_documentation').select('value').eq('key', key).eq('team_id', TEAM_ID).single();
                if (error) throw error;
                return data ? data.value : null;
            } catch (error) {
                return null;
            }
        }

        async function getAllDocuments() {
            if (!supabaseEnabled) return [];
            try {
                const { data, error } = await supabase.from('team_documentation').select('key, value, updated_at').eq('team_id', TEAM_ID).like('key', 'document_%').order('updated_at', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                return [];
            }
        }

        async function saveToStorage(key, data) {
            try {
                if (supabaseEnabled) {
                    await saveToSupabase(key, data);
                }
                localStorage.setItem(`${TEAM_ID}_${key}`, JSON.stringify(data));
            } catch (error) {
                localStorage.setItem(`${TEAM_ID}_${key}`, JSON.stringify(data));
            }
        }

        async function getFromStorage(key) {
            try {
                if (supabaseEnabled) {
                    const data = await getFromSupabase(key);
                    if (data) return data;
                }
                const localData = localStorage.getItem(`${TEAM_ID}_${key}`);
                return localData ? JSON.parse(localData) : null;
            } catch (error) {
                const localData = localStorage.getItem(`${TEAM_ID}_${key}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.sidebar-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'blocks') {
                document.getElementById('blocksTab').classList.add('active');
            } else if (tabName === 'documents') {
                document.getElementById('documentsTab').classList.add('active');
                loadDocumentsList();
            } else if (tabName === 'templates') {
                document.getElementById('templatesTab').classList.add('active');
                loadTemplatesList();
            } else if (tabName === 'clients') {
                document.getElementById('clientsTab').classList.add('active');
                loadClientsList();
            }
        }

        async function createNewDocument() {
            const docId = 'doc_' + Date.now();
            const newDoc = {
                id: docId, name: `Document ${Object.keys(documents).length + 1}`,
                content: [], created: new Date().toISOString(), updated: new Date().toISOString()
            };
            documents[docId] = newDoc;
            await saveDocument(docId);
            await loadDocument(docId);
            loadDocumentsList();
        }

        async function saveDocument(docId) {
            const doc = documents[docId];
            if (!doc) return;
            if (docId === currentDocumentId) {
                const blocks = [];
                document.querySelectorAll('.doc-block').forEach(block => {
                    blocks.push(block.querySelector('.block-content').innerHTML);
                });
                doc.content = blocks;
                doc.updated = new Date().toISOString();
            }
            await saveToStorage(`document_${docId}`, doc);
        }

        async function loadDocument(docId) {
            if (currentDocumentId && documents[currentDocumentId]) {
                await saveCurrentDocument();
            }
            currentDocumentId = docId;
            const doc = documents[docId];
            if (!doc) return;

            // Update document title in header
            document.getElementById('currentDocumentTitle').value = doc.name;

            const docContainer = document.getElementById('document');
            docContainer.innerHTML = '<div class="drop-zone">Drag blocks here to start building your document</div>';
            const dropZone = docContainer.querySelector('.drop-zone');

            if (doc.content && doc.content.length > 0) {
                doc.content.forEach(blockHtml => {
                    const block = document.createElement('div');
                    block.className = 'doc-block';
                    block.draggable = true;
                    block.innerHTML = `<div class="block-controls"><button onclick="removeBlock(this)">Delete</button></div><div class="block-content" contenteditable="true">${blockHtml}</div>`;
                    docContainer.insertBefore(block, dropZone);

                    block.addEventListener('dragstart', () => { draggedElement = block; block.classList.add('dragging'); });
                    block.addEventListener('dragend', () => { block.classList.remove('dragging'); draggedElement = null; });
                });
            }
            loadDocumentsList();
        }

        function updateDocumentName() {
            if (currentDocumentId && documents[currentDocumentId]) {
                const newName = document.getElementById('currentDocumentTitle').value.trim();
                if (newName) {
                    documents[currentDocumentId].name = newName;
                    documents[currentDocumentId].updated = new Date().toISOString();
                    saveCurrentDocument();
                    loadDocumentsList();
                }
            }
        }

        async function manualSaveDocument() {
            const saveBtn = document.getElementById('saveButtonText');
            const originalText = saveBtn.textContent;
            
            saveBtn.textContent = '‚è≥ Saving...';
            saveBtn.parentElement.classList.add('saving');
            
            await saveCurrentDocument();
            
            saveBtn.textContent = '‚úì Saved!';
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.parentElement.classList.remove('saving');
            }, 2000);
        }

        async function deleteDocument(docId) {
            if (!confirm('Delete this document?')) return;
            delete documents[docId];
            if (supabaseEnabled) {
                try {
                    await supabase.from('team_documentation').delete().eq('key', `document_${docId}`).eq('team_id', TEAM_ID);
                } catch (error) {}
            }
            localStorage.removeItem(`${TEAM_ID}_document_${docId}`);
            if (currentDocumentId === docId) {
                await createNewDocument();
            } else {
                loadDocumentsList();
            }
        }

        async function renameDocument(docId) {
            const doc = documents[docId];
            if (!doc) return;
            const newName = prompt('Enter new document name:', doc.name);
            if (newName && newName.trim()) {
                doc.name = newName.trim();
                doc.updated = new Date().toISOString();
                await saveDocument(docId);
                loadDocumentsList();
            }
        }

        async function loadDocumentsList() {
            const listContainer = document.getElementById('documentsList');
            if (supabaseEnabled) {
                try {
                    const allDocs = await getAllDocuments();
                    allDocs.forEach(item => {
                        const docId = item.key.replace('document_', '');
                        if (!documents[docId]) documents[docId] = item.value;
                    });
                } catch (error) {}
            }

            if (Object.keys(documents).length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No documents yet.<br>Create your first one!</p></div>';
                return;
            }

            const sortedDocs = Object.values(documents).sort((a, b) => new Date(b.updated) - new Date(a.updated));
            listContainer.innerHTML = sortedDocs.map(doc => {
                const date = new Date(doc.updated).toLocaleDateString();
                const time = new Date(doc.updated).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const preview = doc.content.length > 0 ? doc.content[0].replace(/<[^>]*>/g, '').substring(0, 50) + '...' : 'Empty document';
                const isActive = doc.id === currentDocumentId;
                return `<div class="document-item ${isActive ? 'active' : ''}" onclick="loadDocument('${doc.id}')"><div class="document-item-header"><div class="document-item-title">${doc.name}</div><div class="document-item-actions" onclick="event.stopPropagation()"><button class="rename-btn" onclick="renameDocument('${doc.id}')">‚úèÔ∏è</button><button onclick="deleteDocument('${doc.id}')">üóëÔ∏è</button></div></div><div class="document-item-date">${date} ${time}</div><div class="document-item-preview">${preview}</div></div>`;
            }).join('');
        }

        async function saveCurrentDocument() {
            if (!currentDocumentId || !documents[currentDocumentId]) return;
            const blocks = [];
            document.querySelectorAll('.doc-block').forEach(block => {
                blocks.push(block.querySelector('.block-content').innerHTML);
            });
            documents[currentDocumentId].content = blocks;
            documents[currentDocumentId].updated = new Date().toISOString();
            await saveDocument(currentDocumentId);
        }

        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = Object.keys(groups).map(groupId => {
                const group = groups[groupId];
                return `<div class="block-group"><div class="group-header" onclick="toggleGroup('${groupId}')"><span class="group-arrow">‚ñº</span><span class="group-title">${group.name}</span><div class="group-controls" onclick="event.stopPropagation()"><button class="duplicate-btn" onclick="duplicateGroup('${groupId}')">Duplicate</button><button onclick="editGroup('${groupId}')">Edit</button><button onclick="deleteGroup('${groupId}')">Delete</button></div></div><div class="block-palette" id="palette-${groupId}">${Object.keys(group.blocks).map(blockId => `<div class="block-template" draggable="true" data-group="${groupId}" data-block="${blockId}"><span>${group.blocks[blockId].name}</span><div class="block-template-buttons"><button class="edit-template-btn" onclick="event.stopPropagation(); editTemplate('${groupId}', '${blockId}')">Edit</button><button class="move-template-btn" onclick="event.stopPropagation(); openMoveBlockModal('${groupId}', '${blockId}')">Move</button><button class="edit-template-btn" onclick="event.stopPropagation(); duplicateBlock('${groupId}', '${blockId}')">Copy</button></div></div>`).join('')}<button class="add-block-btn" onclick="addBlockToGroup('${groupId}')">+ Add Block</button><button class="import-docx-btn" onclick="importDocxAsBlock('${groupId}')">üìÑ Import DOCX</button></div></div>`;
            }).join('');

            document.querySelectorAll('.block-template').forEach(template => {
                template.addEventListener('dragstart', (e) => {
                    draggedType = { groupId: e.target.dataset.group, blockId: e.target.dataset.block };
                });
            });
        }

        function toggleGroup(groupId) {
            document.getElementById(`palette-${groupId}`).classList.toggle('collapsed');
            document.getElementById(`palette-${groupId}`).previousElementSibling.classList.toggle('collapsed');
        }

        function addGroup() {
            groupCounter++;
            groups[`group-${groupCounter}`] = { name: `New Group ${groupCounter}`, blocks: {} };
            renderGroups();
        }

        function deleteGroup(groupId) {
            if (confirm('Delete this group?')) {
                delete groups[groupId];
                renderGroups();
            }
        }

        function duplicateGroup(groupId) {
            groupCounter++;
            const originalGroup = groups[groupId];
            const newGroupId = `group-${groupCounter}`;
            
            groups[newGroupId] = {
                name: originalGroup.name + ' (Copy)',
                blocks: JSON.parse(JSON.stringify(originalGroup.blocks)) // Deep clone
            };
            
            renderGroups();
        }

        function duplicateBlock(groupId, blockId) {
            blockCounter++;
            const originalBlock = groups[groupId].blocks[blockId];
            const newBlockId = `block-${blockCounter}`;
            
            groups[groupId].blocks[newBlockId] = {
                name: originalBlock.name + ' (Copy)',
                content: originalBlock.content
            };
            
            renderGroups();
        }

        function openMoveBlockModal(groupId, blockId) {
            blockToMove = { groupId, blockId };
            
            // Populate target group select
            const select = document.getElementById('targetGroupSelect');
            select.innerHTML = Object.keys(groups).map(gId => {
                if (gId !== groupId) {
                    return `<option value="${gId}">${groups[gId].name}</option>`;
                }
                return '';
            }).join('');
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('moveBlockModal').classList.add('active');
        }

        function closeMoveBlockModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('moveBlockModal').classList.remove('active');
            blockToMove = null;
        }

        function confirmMoveBlock() {
            if (!blockToMove) return;
            
            const targetGroupId = document.getElementById('targetGroupSelect').value;
            if (!targetGroupId) return;
            
            const { groupId, blockId } = blockToMove;
            const block = groups[groupId].blocks[blockId];
            
            // Add to target group
            groups[targetGroupId].blocks[blockId] = block;
            
            // Remove from source group
            delete groups[groupId].blocks[blockId];
            
            renderGroups();
            closeMoveBlockModal();
        }

        function editGroup(groupId) {
            currentEditingGroup = groupId;
            document.getElementById('groupName').value = groups[groupId].name;
            document.getElementById('groupModal').classList.add('active');
        }

        function saveGroupName() {
            if (currentEditingGroup) {
                const newName = document.getElementById('groupName').value.trim();
                if (newName) {
                    groups[currentEditingGroup].name = newName;
                    renderGroups();
                }
            }
            closeModal();
        }

        function addBlockToGroup(groupId) {
            blockCounter++;
            groups[groupId].blocks[`block-${blockCounter}`] = { name: `New Block ${blockCounter}`, content: '<p>New block content</p>' };
            renderGroups();
        }

        function importDocxAsBlock(groupId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.docx';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                        const html = result.value;
                        
                        if (html) {
                            blockCounter++;
                            const blockId = `imported-${blockCounter}`;
                            const fileName = file.name.replace('.docx', '');
                            
                            groups[groupId].blocks[blockId] = {
                                name: fileName,
                                content: html
                            };
                            
                            renderGroups();
                            alert(`‚úÖ "${fileName}" imported successfully! You can now edit it or drag it to your document.`);
                        } else {
                            alert('‚ö†Ô∏è Could not extract content from the DOCX file.');
                        }
                    } catch (error) {
                        console.error('Error importing DOCX:', error);
                        alert('‚ùå Error importing DOCX file: ' + error.message);
                    }
                }
            };
            input.click();
        }

        function editTemplate(groupId, blockId) {
            currentEditingTemplate = { groupId, blockId };
            const block = groups[groupId].blocks[blockId];
            
            // Set block name
            document.getElementById('blockName').value = block.name;
            
            // Set content
            const editor = document.getElementById('blockEditorContent');
            editor.innerHTML = block.content;
            
            document.getElementById('editModal').classList.add('active');
            
            // Focus the editor
            setTimeout(() => editor.focus(), 100);
        }

        function editorFormat(command, value = null) {
            const editor = document.getElementById('blockEditorContent');
            editor.focus();
            
            if (value) {
                document.execCommand(command, false, value);
            } else {
                document.execCommand(command, false, null);
            }
            
            // Update button states for toggle commands
            updateEditorButtonStates();
        }

        function updateEditorButtonStates() {
            const commands = ['bold', 'italic', 'underline'];
            const buttons = document.querySelectorAll('.block-editor-btn');
            
            buttons.forEach(btn => {
                const title = btn.getAttribute('title');
                if (title && commands.includes(title.toLowerCase())) {
                    const command = title.toLowerCase();
                    if (document.queryCommandState(command)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        // Update button states on selection change
        document.addEventListener('selectionchange', () => {
            const editor = document.getElementById('blockEditorContent');
            if (document.activeElement === editor) {
                updateEditorButtonStates();
            }
        });

        function saveTemplate() {
            if (currentEditingTemplate) {
                const { groupId, blockId } = currentEditingTemplate;
                const newName = document.getElementById('blockName').value.trim();
                const newContent = document.getElementById('blockEditorContent').innerHTML;
                
                if (newName) {
                    groups[groupId].blocks[blockId].name = newName;
                }
                groups[groupId].blocks[blockId].content = newContent;
                renderGroups();
            }
            closeModal();
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('groupModal').classList.remove('active');
            currentEditingTemplate = null;
            currentEditingGroup = null;
            
            // Clear editor
            document.getElementById('blockName').value = '';
            document.getElementById('blockEditorContent').innerHTML = 'Start typing or format your text...';
            document.getElementById('editorFontFamily').value = '';
            document.getElementById('editorFontSize').value = '';
        }

        function formatText(command) {
            document.execCommand(command, false, null);
        }

        function changeFontSize(size) {
            if (size && currentEditingBlock) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = size;
                    try {
                        range.surroundContents(span);
                    } catch (e) {
                        const fragment = range.extractContents();
                        const wrapper = document.createElement('span');
                        wrapper.style.fontSize = size;
                        wrapper.appendChild(fragment);
                        range.insertNode(wrapper);
                    }
                }
            }
        }

        const doc = document.getElementById('document');
        const toolbar = document.getElementById('toolbar');

        doc.addEventListener('dragover', (e) => e.preventDefault());
        doc.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedType) {
                const { groupId, blockId } = draggedType;
                addBlock(groupId, blockId);
                draggedType = null;
            } else if (draggedElement) {
                const dropZone = e.target.closest('.drop-zone');
                if (dropZone) doc.insertBefore(draggedElement, dropZone);
            }
        });

        document.addEventListener('focusin', (e) => {
            if (e.target.classList.contains('block-content')) {
                toolbar.classList.add('active');
                currentEditingBlock = e.target;
                document.querySelectorAll('.doc-block').forEach(b => b.classList.remove('editing'));
                e.target.closest('.doc-block').classList.add('editing');
            }
        });

        document.addEventListener('focusout', (e) => {
            setTimeout(() => {
                if (!document.activeElement.classList.contains('block-content') && !document.activeElement.closest('.formatting-toolbar')) {
                    const editingBlock = document.querySelector('.doc-block.editing');
                    if (editingBlock) editingBlock.classList.remove('editing');
                }
            }, 200);
        });

        function addBlock(groupId, blockId) {
            const dropZone = doc.querySelector('.drop-zone');
            const template = groups[groupId].blocks[blockId];
            const block = document.createElement('div');
            block.className = 'doc-block';
            block.draggable = true;
            block.innerHTML = `<div class="block-controls"><button onclick="removeBlock(this)">Delete</button></div><div class="block-content" contenteditable="true">${template.content}</div>`;
            doc.insertBefore(block, dropZone);

            const uploadAreas = block.querySelectorAll('.image-upload-area');
            uploadAreas.forEach(area => area.contentEditable = false);

            block.addEventListener('dragstart', () => { draggedElement = block; block.classList.add('dragging'); });
            block.addEventListener('dragend', () => { block.classList.remove('dragging'); draggedElement = null; });
        }

        function uploadImage(element) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        element.outerHTML = `<img src="${event.target.result}" alt="Uploaded image">`;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function removeBlock(btn) {
            btn.closest('.doc-block').remove();
        }

        function saveProject() {
            const blocks = [];
            document.querySelectorAll('.doc-block').forEach(block => {
                blocks.push(block.querySelector('.block-content').innerHTML);
            });
            const project = { groups: groups, documents: documents };
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'documentation-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const project = JSON.parse(event.target.result);
                            Object.assign(groups, project.groups);
                            Object.assign(documents, project.documents);
                            renderGroups();
                            if (Object.keys(documents).length > 0) {
                                const firstDoc = Object.values(documents)[0];
                                await loadDocument(firstDoc.id);
                            }
                            alert('Project loaded successfully!');
                        } catch (error) {
                            alert('Error loading project: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        async function exportToDocx() {
            const blocks = document.querySelectorAll('.doc-block');
            if (blocks.length === 0) {
                alert('Add some blocks first!');
                return;
            }

            const children = [];
            for (const block of blocks) {
                const content = block.querySelector('.block-content');
                const element = content.firstElementChild;
                if (element.tagName === 'H1') {
                    children.push(new docx.Paragraph({ text: element.textContent, heading: docx.HeadingLevel.HEADING_1 }));
                } else if (element.tagName === 'H2') {
                    children.push(new docx.Paragraph({ text: element.textContent, heading: docx.HeadingLevel.HEADING_2 }));
                } else if (element.tagName === 'H3') {
                    children.push(new docx.Paragraph({ text: element.textContent, heading: docx.HeadingLevel.HEADING_3 }));
                } else if (element.tagName === 'P') {
                    children.push(new docx.Paragraph({ text: element.textContent }));
                } else if (element.tagName === 'UL') {
                    element.querySelectorAll('li').forEach(li => {
                        children.push(new docx.Paragraph({ text: li.textContent, bullet: { level: 0 } }));
                    });
                } else if (element.tagName === 'OL') {
                    element.querySelectorAll('li').forEach(li => {
                        children.push(new docx.Paragraph({ text: li.textContent, numbering: { reference: 'default-numbering', level: 0 } }));
                    });
                } else if (element.tagName === 'IMG') {
                    try {
                        const response = await fetch(element.src);
                        const blob = await response.blob();
                        const arrayBuffer = await blob.arrayBuffer();
                        children.push(new docx.Paragraph({
                            children: [new docx.ImageRun({ data: arrayBuffer, transformation: { width: 600, height: 400 } })]
                        }));
                    } catch (error) {}
                }
            }

            const docFile = new docx.Document({
                numbering: { config: [{ reference: 'default-numbering', levels: [{ level: 0, format: docx.LevelFormat.DECIMAL, text: '%1.', alignment: docx.AlignmentType.LEFT }] }] },
                sections: [{ properties: {}, children: children }]
            });

            const blob = await docx.Packer.toBlob(docFile);
            saveAs(blob, 'document.docx');
        }

        async function autoSave() {
            await saveCurrentDocument();
            await saveToStorage('sharedTemplates', groups);
        }

        async function autoLoad() {
            // Login disabled - load immediately
            try {
                const sharedGroups = await getFromStorage('sharedTemplates');
                if (sharedGroups) {
                    Object.assign(groups, sharedGroups);
                }
                renderGroups();

                // Load clients
                const loadedClients = await getFromStorage('clients');
                if (loadedClients) {
                    Object.assign(clients, loadedClients);
                }

                // Load templates
                const loadedTemplates = await getFromStorage('templates');
                if (loadedTemplates) {
                    Object.assign(templates, loadedTemplates);
                }

                if (supabaseEnabled) {
                    const allDocs = await getAllDocuments();
                    allDocs.forEach(item => {
                        const docId = item.key.replace('document_', '');
                        documents[docId] = item.value;
                    });
                } else {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(`${TEAM_ID}_document_`)) {
                            try {
                                const docId = key.replace(`${TEAM_ID}_document_`, '');
                                documents[docId] = JSON.parse(localStorage.getItem(key));
                            } catch (e) {}
                        }
                    });
                }

                if (Object.keys(documents).length > 0) {
                    const sortedDocs = Object.values(documents).sort((a, b) => new Date(b.updated) - new Date(a.updated));
                    await loadDocument(sortedDocs[0].id);
                } else {
                    await createNewDocument();
                }
            } catch (error) {
                console.error('Error in autoLoad:', error);
                await createNewDocument();
            }
        }

        let saveTimeout;
        function triggerAutoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSave, 1000);
        }

        document.addEventListener('input', triggerAutoSave);
        document.addEventListener('DOMNodeInserted', triggerAutoSave);
        document.addEventListener('DOMNodeRemoved', triggerAutoSave);

        // Initialize app
        window.addEventListener('load', () => {
            // Login disabled - start app immediately
            autoLoad();
            
            /* Original code - uncomment when login is re-enabled:
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userRole').textContent = currentUser.role;
                    document.getElementById('userRole').className = `role-badge ${currentUser.role}`;
                    updateUIForRole();
                    autoLoad();
                } catch (e) {
                    console.error('Error loading saved user:', e);
                    localStorage.removeItem('currentUser');
                }
            }
            */
        });
    </script>
</body>
</html>
